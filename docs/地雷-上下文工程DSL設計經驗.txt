# 上下文工程 DSL 設計經驗

## 發生時機
當設計知識驅動的 LLM 解題系統、建立知識庫與模板架構、使用 ripgrep 做平行檢索時

## 地雷與解法

### 地雷1：知識庫標記「變體」導致 LLM 誤判為「也算對」

問題：知識庫寫「蜂湧(變體)→蜂擁(標準)」，LLM 理解為「變體也是正確的」

症狀：字形題 LLM 選了含有「蜂湧」的選項，認為它是對的

解法：
- 用明確的「錯」標記：「蜂湧(錯)→蜂擁(對)」
- 在知識內容中強調：「考試中視為錯誤！」
- common_errors 格式統一為：「錯誤寫法(錯)→正確寫法(對)」

### 地雷2：LLM 自行推測知識庫未涵蓋的細節

問題：知識庫沒有記載「王粲詩歌抒情性強」，LLM 自己推測「王粲詩歌並非抒情性強」並選錯答案

症狀：國學題 LLM 選了 A 而非正確答案 C，因為錯誤地否定了 C 選項的某個細節

解法：
- 擴充知識庫涵蓋所有可能考點
- 在模板中加入指導：「如果知識庫沒有明確說某件事是錯的，就不要自行推測它是錯的」
- key_facts 欄位列出所有重要事實

### 地雷3：LLM 誤讀字形題的「」內文字

問題：選項格式「「賑」災濟貧」，LLM 誤讀為「振災」

症狀：LLM 的推理說「『振』災是錯誤用法」，但題目用的是「賑」

解法：
- 模板加入格式說明範例
- 強調「請特別注意：看清楚『』內是什麼字，不要混淆！」
- 逐步分析每個「」內的字

### 地雷4：平行 rg 檢索未正確匹配知識

問題：CH-001 字形題找到 0 條知識，因為關鍵字沒有匹配到知識庫

症狀：知識庫有「厲vs勵」、「蜂擁vs蜂湧」，但檢索找不到

解法：
- 建立常見形近字組列表：['厲', '勵'], ['蜂', '鋒'], ['擁', '湧']...
- 題目出現任一字時，自動加入整組關鍵字搜尋
- 平行執行多組 rg 搜尋避免遺漏

## 最佳實踐

### 知識庫設計
```jsonl
{
  "common_errors": ["錯誤(錯)→正確(對)"],  // 明確標記對錯
  "key_facts": ["重點1", "重點2"],           // 列出所有考點
  "content": "...考試中視為錯誤！..."        // 強調語氣
}
```

### 模板設計
```
## 重要：理解題目格式
每個選項格式為：「字1」詞組1／「字2」詞組2
請特別注意：看清楚「」內是什麼字，不要混淆！

## 重要原則
1. 只根據「相關知識」判斷
2. 如果知識庫沒有明確說某件事是錯的，就不要自行推測
```

### 平行 rg 檢索
```javascript
// 提取常見形近字組
const charPairs = [['厲', '勵'], ['蜂', '鋒'], ['擁', '湧']...];
for (const pair of charPairs) {
  if (pair.some(c => fullText.includes(c))) {
    matchedChars.push(...pair);  // 加入整組
  }
}

// Promise.all 平行執行
const results = await Promise.all(searches.map(s => s.promise));
```

## 成果
- Gemma 3 12B IT：5/5 正確 (100%)
- 平行 rg 檢索速度：10-25ms/題
- 知識庫：3 檔案，13 條知識

## 相關檔案
- skill/knowledge/*.jsonl：知識庫
- skill/templates/reasoning.jsonl：推理模板
- skill/scripts/solver.mjs：主解題腳本
