# 關鍵字提取方案設計比較

## 需求分析

1. **泛化能力**：能處理任何高中國文學測題目
2. **不洩漏答案**：提取關鍵字時不能暗示答案（避免 overfitting）
3. **JSONL 輸出**：方便後續處理
4. **BDD/TDD/SOLID/DRY**：良好的軟體設計

---

## 方案一：單次直接提取

### 設計
一次 LLM 呼叫，直接從題目提取所有可能的知識點關鍵字。

### Prompt 策略
```
你是關鍵字提取專家。從以下國文題目中提取「需要查詢知識庫」的關鍵字。

規則：
1. 只提取「知識點」，不提取「題目指令」（如「下列」「何者」「正確」）
2. 不要判斷對錯，只提取需要查證的詞彙
3. 每個選項分開提取

題目：{{question}}
選項：{{options}}

輸出 JSONL（每行一個 JSON）：
{"type": "stem", "keywords": ["關鍵字1", "關鍵字2"]}
{"type": "option_A", "keywords": ["關鍵字1"]}
{"type": "option_B", "keywords": ["關鍵字1"]}
...
```

### 優點
- 只呼叫 1 次 LLM
- 實作簡單

### 缺點
- 無法區分關鍵字的重要性
- 可能遺漏隱含的知識點（如「三蘇」隱含「父子關係」）

### 評分

| 維度 | 分數 | 說明 |
|------|------|------|
| 泛化能力 | 7 | 能處理大多數題目，但遺漏隱含知識 |
| 不洩漏答案 | 9 | 只提取詞彙，不判斷對錯 |
| 準確度 | 6 | 可能提取無用詞彙 |
| 成本效率 | 9 | 只呼叫 1 次 |
| 可維護性 | 8 | 簡單直接 |

**總分：7.8 / 10**

---

## 方案二：分層提取（題型識別 + 針對性提取）

### 設計
兩次 LLM 呼叫：
1. 第一次：識別題型類別
2. 第二次：根據題型使用專門的提取策略

### Prompt 策略

**第一次：題型識別**
```
判斷這道國文題目的類型。

題目：{{question}}

輸出 JSONL：
{"question_type": "字形辨識|成語應用|國學常識|文言閱讀|修辭手法|語意理解", "sub_type": "具體子類型"}
```

**第二次：針對性提取**
```
# 字形辨識專用
提取所有需要辨別的字形，包含：
- 「」內的目標字
- 可能的形近字
- 詞語搭配

# 國學常識專用
提取所有需要查證的：
- 人名、作品名、朝代
- 人物關係詞（父子、兄弟、師生）
- 文學主張、流派名稱
```

### 優點
- 針對不同題型有專門策略
- 更精確的關鍵字

### 缺點
- 呼叫 2 次 LLM
- 題型判斷錯誤會連帶影響提取

### 評分

| 維度 | 分數 | 說明 |
|------|------|------|
| 泛化能力 | 8 | 專門策略涵蓋更多情況 |
| 不洩漏答案 | 8 | 題型識別可能輕微暗示 |
| 準確度 | 8 | 針對性提取更精確 |
| 成本效率 | 6 | 呼叫 2 次 |
| 可維護性 | 6 | 需維護多套提取策略 |

**總分：7.2 / 10**

---

## 方案三：多角度單次提取

### 設計
一次 LLM 呼叫，但從多個角度提取：
1. **顯性詞彙**：題目中明確出現的專有名詞
2. **隱含概念**：需要查證但未直接出現的相關知識
3. **易混淆項**：選項之間容易混淆的對比點

### Prompt 策略
```
你是高中國文知識檢索專家。分析題目，提取需要查詢知識庫的關鍵字。

## 輸入
題目：{{question}}
選項：{{options}}

## 提取規則

1. **顯性詞彙**：題目和選項中明確出現的
   - 人名、書名、朝代、流派
   - 成語、典故
   - 需要辨識的字形

2. **隱含概念**：未直接出現但需要知道的
   - 人物關係（看到「三蘇」要加「父子」「兄弟」）
   - 作品歸屬（看到作品名要加作者）
   - 時代背景（看到人名要加朝代）

3. **對比維度**：選項之間的差異點
   - 不同選項提到的不同人/事/物
   - 需要區分的易混淆概念

## 禁止事項
- 不要判斷選項對錯
- 不要推測答案
- 不要提取「下列」「何者」「正確」等題目指令

## 輸出格式（JSONL，每行一個 JSON）
{"category": "explicit", "source": "stem|option_A|option_B|option_C|option_D", "keyword": "關鍵字", "related": ["相關詞1", "相關詞2"]}
{"category": "implicit", "source": "stem", "keyword": "隱含概念", "reason": "為什麼需要這個"}
{"category": "contrast", "keywords": ["對比項1", "對比項2"], "dimension": "對比的維度"}
```

### 範例輸出
```jsonl
{"category": "explicit", "source": "option_B", "keyword": "三蘇", "related": ["蘇洵", "蘇軾", "蘇轍"]}
{"category": "implicit", "source": "option_B", "keyword": "父子關係", "reason": "三蘇的成員關係是常考點"}
{"category": "contrast", "keywords": ["父子", "兄弟"], "dimension": "人物關係"}
{"category": "explicit", "source": "option_C", "keyword": "朱右", "related": ["八先生文集", "明代"]}
{"category": "explicit", "source": "option_C", "keyword": "茅坤", "related": ["唐宋八大家文鈔"]}
```

### 優點
- 一次呼叫涵蓋多角度
- 隱含概念提取增強泛化
- 對比維度幫助理解題目考點

### 缺點
- Prompt 較複雜
- 需要 LLM 有足夠理解能力

### 評分

| 維度 | 分數 | 說明 |
|------|------|------|
| 泛化能力 | 9 | 多角度涵蓋顯性+隱含知識 |
| 不洩漏答案 | 9 | 明確禁止判斷對錯 |
| 準確度 | 9 | 結構化輸出便於驗證 |
| 成本效率 | 8 | 只呼叫 1 次 |
| 可維護性 | 8 | 單一 prompt 易於調整 |

**總分：8.6 / 10**

---

## 方案比較總結

| 方案 | 泛化 | 不洩漏 | 準確 | 成本 | 維護 | 總分 |
|------|------|--------|------|------|------|------|
| 方案一：單次直接 | 7 | 9 | 6 | 9 | 8 | **7.8** |
| 方案二：分層提取 | 8 | 8 | 8 | 6 | 6 | **7.2** |
| 方案三：多角度單次 | 9 | 9 | 9 | 8 | 8 | **8.6** |

---

## 結論

**選擇方案三：多角度單次提取**

理由：
1. **泛化能力最強**：顯性+隱含+對比三角度涵蓋完整
2. **成本效率高**：只呼叫 1 次 LLM
3. **不洩漏答案**：明確規則禁止判斷對錯
4. **結構化輸出**：JSONL 格式易於後續處理
5. **可驗證**：每個關鍵字都有 category 和 source 可追溯

### 實作要點

1. **輸入輸出分離**：提取器只負責提取，不負責解題
2. **JSONL 格式驗證**：確保輸出可解析
3. **fallback 機制**：LLM 輸出格式錯誤時的處理
4. **快取機制**：相同題目不重複提取
